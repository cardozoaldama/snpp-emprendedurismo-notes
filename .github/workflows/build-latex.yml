name: Build LaTeX Document

on:
  push:
    branches: [main]
    tags:
      - 'v*'
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version information
        id: version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.2.1")
            VERSION="${VERSION}-dev+$(git rev-parse --short HEAD)"
          fi

          # Check if this is a pre-release
          if [[ $VERSION == *"-draft"* ]] || [[ $VERSION == *"-rc"* ]] || [[ $VERSION == *"-dev"* ]]; then
            IS_PRERELEASE=true
          else
            IS_PRERELEASE=false
          fi

          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "IS_PRERELEASE=$IS_PRERELEASE" >> $GITHUB_OUTPUT
          echo "BUILD_DATE=$(date -u +'%Y-%m-%d')" >> $GITHUB_OUTPUT
          echo "GIT_COMMIT=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Generate version.tex
        working-directory: latex
        run: |
          cat > version.tex << 'EOF'
          % Auto-generated version information
          % Do not edit manually - this file is generated by CI

          \newcommand{\docversion}{${{ steps.version.outputs.VERSION }}}
          \newcommand{\builddate}{${{ steps.version.outputs.BUILD_DATE }}}
          \newcommand{\gitcommit}{${{ steps.version.outputs.GIT_COMMIT }}}
          EOF
          cat version.tex

      - name: Compile LaTeX document
        uses: xu-cheng/latex-action@v3
        with:
          root_file: main.tex
          working_directory: latex
          compiler: lualatex
          args: -interaction=nonstopmode -file-line-error
          post_compile: "lualatex -interaction=nonstopmode -file-line-error main.tex"

      - name: Rename PDF with version
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          # Versioned PDF
          mv latex/main.pdf latex/competencias-emprendedoras-${VERSION}.pdf
          # Generic PDF for stable linking
          cp latex/competencias-emprendedoras-${VERSION}.pdf latex/competencias-emprendedoras.pdf

      - name: Upload PDF artifacts
        uses: actions/upload-artifact@v4
        with:
          name: competencias-emprendedoras
          path: latex/competencias-emprendedoras*.pdf
          retention-days: 30

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            latex/competencias-emprendedoras-${{ steps.version.outputs.VERSION }}.pdf
            latex/competencias-emprendedoras.pdf
          prerelease: ${{ steps.version.outputs.IS_PRERELEASE }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
